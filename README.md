# DocuCortex

**DocuCortex** — это AI-ассистент для анализа документов и ответов на вопросы по их содержимому с использованием RAG (Retrieval-Augmented Generation).

---

## 1. Запуск проекта (Docker)

1.  **Создайть файл `.env`**:
    Скопировать содержимое из `.env.example` и вставить `OPENAI_API_KEY`.

    ```
    cp .env.example .env
    ```

2.  **Запуск в Docker Compose**:

    ```
    docker-compose up -d --build
    ```

3.  **Проверка доступности**:
    Сервис будет доступен по адресу `http://localhost:8000`.
    Документация OpenAPI (Swagger) будет доступна по адресу `http://localhost:8000/docs`.

---

## 2. Запуск тестов

```
docker-compose exec app pytest
```

---

## 3. API Эндпоинты

### Documents
- `POST /api/v1/documents`
  - **Описание**: Загружает документ (PDF или TXT) для анализа. Сервис извлекает и сохраняет текстовое содержимое.
  - **Ответ**: Возвращает уникальный `documentId`, имя файла и `contentType`.

- `GET /api/v1/documents/{document_id}/summary`
  - **Описание**: Генерирует и возвращает краткое содержание (summary) для ранее загруженного документа.
  - **Ответ**: Возвращает `documentId` и `summary`.

### Chat
- `POST /api/v1/chat/conversations`
  - **Описание**: Начинает чат на основе содержимого указанного документа. Использует RAG для поиска релевантных фрагментов текста и генерации ответа.
  - **Тело запроса**: `documentId` и `query` (ваш вопрос).
  - **Ответ**: `answer` (ответ от AI), `sources` и `documentId`.

---

## 4. Структура проекта

```bash
.
├── .env.example                   # Пример файла с переменными окружения для локального запуска
├── .gitignore                     # Список файлов и папок, которые игнорируются системой контроля версий Git
├── .pre-commit-config.yaml        # Конфигурация pre-commit хуков (для линтинга и форматирования перед коммитом)
├── docker-compose.yml             # Определяет сервисы, сети и тома для запуска приложения в Docker
├── Dockerfile                     # Инструкции по сборке Docker-образа для основного приложения
├── pyproject.toml                 # Стандартный файл конфигурации проекта Python (настройки pytest, build-system)
├── requirements.txt               # Список зависимостей Python, необходимых для работы проекта
├── src/                           # Основная папка с исходным кодом приложения
│   ├── __init__.py                # Делает src пакетом Python
│   ├── api/                       # Слой API, отвечающий за HTTP эндпоинты
│   │   └── v1/                    # Версия v1 нашего API
│   │       ├── chat.py            # Эндпоинт для RAG-чата с документами
│   │       └── documents.py       # Эндпоинты для загрузки документов и получения summary
│   ├── core/                      # Ядро приложения: сквозная функциональность
│   │   ├── config.py              # Загрузка и управление конфигурацией (включая секреты из .env)
│   │   └── logging.py             # Настройка и конфигурация логгера (Loguru)
│   ├── models/                    # Слой моделей данных (Pydantic)
│   │   ├── chat.py                # Модели данных для запросов и ответов чата
│   │   └── documents.py           # Модели данных для загрузки файлов и получения summary
│   ├── prompts/                   # Шаблоны промптов для взаимодействия с LLM
│   │   ├── rag_prompt.jinja2      # Промпт для ответа на вопрос на основе контекста (RAG)
│   │   └── summary_prompt.jinja2  # Промпт для генерации краткого содержания текста
│   ├── services/                  # Слой бизнес-логики
│   │   ├── analysis_service.py    # Сервис для анализа текста (генерация summary)
│   │   ├── chat_service.py        # Сервис, реализующий логику RAG-чата и Guardrails
│   │   └── document_service.py    # Сервис для обработки файлов (извлечение текста, сохранение)
│   └── main.py                    # Точка входа в приложение: инициализация FastAPI, роутеров, lifespan
├── templates/                     # HTML-шаблоны
│   └── index.html                 # Простая веб-страница для демонстрации
└── tests/                         # Папка с автоматическими тестами
    ├── conftest.py                # Общие фикстуры и хелперы для тестов (Pytest)
    ├── test_analysis_service.py   # Тесты для сервиса анализа
    ├── test_chat_service.py       # Тесты для сервиса чата
    ├── test_documents_api.py      # Тесты для API документов
    └── test_main.py               # Тесты для основного приложения и health-check
```

---

## 5. Жизненный цикл запроса (Pipeline)

1.  **Загрузка**: Пользователь отправляет `POST` запрос с файлом (PDF/TXT) на эндпоинт `/api/v1/documents`.
2.  **Обработка**: `DocumentService` определяет тип файла, извлекает из него чистый текст и сохраняет его в локальное хранилище. Пользователь получает в ответ `documentId`.
3.  **Анализ (Summary)**: Пользователь запрашивает краткое содержание, отправляя `GET` запрос на `/documents/{document_id}/summary`. `AnalysisService` читает текст документа, использует специальный промпт и LLM (OpenAI) для генерации summary.
4.  **Чат (RAG)**: Пользователь задает вопрос к документу через `POST` на `/chat/conversations`. Этот процесс включает в себя несколько стадий:
    - **Guardrail (защита) на входе**: Первым делом, текст вопроса (`query`) отправляется в **OpenAI Moderation API**.
    -  **Индексация и ретривер (поиск)**: Сервис находит или создает векторную базу данных **ChromaDB** для указанного `documentId`.
    -  **Поиск контекста**: Вопрос пользователя используется для поиска релевантных фрагментов в векторной базе.
    -  **DAG (Directed Acyclic Graph) Execution**: Основная логика генерации ответа выполняется как **DAG**:
        - **Вход**: Словарь, содержащий найденный `контекст` и оригинальный `вопрос`.
        - **Промпт**: Входные данные форматируются с помощью шаблона `rag_prompt.jinja2`, который инструктирует модель, как отвечать на основе контекста.
        - **LLM**: Сформированный промпт отправляется в модель `gpt-4o`.
        - **Парсер вывода**: Ответ от модели обрабатывается `StrOutputParser()`.
    -  **Guardrail (защита) на выходе**: Сгенерированный моделью ответ, также отправляется в **OpenAI Moderation API**.
    -  **Формирование ответа**: Финальный (безопасный) ответ вместе с найденными исходными фрагментами текста (`sources`) и `documentId`.

---
